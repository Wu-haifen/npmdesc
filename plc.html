<script type="text/html" data-template-name="Keyence">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> 名称</label>
        <input type="text" id="node-input-name" placeholder="name">
    </div>
    <div class="form-row">
        <label for="node-input-server"><i class="fa fa-globe"></i> 服务器</label>
        <input type="text" id="node-input-server" placeholder="ip.address" style="width:45%"> 端口
        <input type="text" id="node-input-port" style="width:60px" placeholder="ip.port">
    </div>
    <div class="form-row">
        <label for="node-input-out"><i class="fa fa-sign-out"></i> 返回</label>
        <select type="text" id="node-input-out" style="width:54%;">
            <option value="time">指定时间后</option>
            <option value="char">当收到某个字符为</option>
            <option value="count">指定字符数</option>
            <option value="sit">保持连接</option>
            <option value="immed">不需要等待回复</option>
        </select>
        <input type="text" id="node-input-splitc" style="width:50px;">
        <span id="node-units"></span>
    </div>
    <div class="form-row border_bottom">
        <label for="node-input-model"><i class="fa fa-dot-circle-o"></i> 模式</label>
        <select id="node-input-model" style="width:20%;">
            <option value="read">读地址</option>
            <option value="write">写地址</option>
        </select>
    </div>
    <div class="form-row">
        <ul class="RD">
            <li>
                <label for="node-input-RD_Addr"></i> 起始地址</label>
                <input style="width:20%;" type="text" id="node-input-RD_Addr" placeholder="start address">
            </li>
            <li>
                <label for="node-input-RD_Num"> 读取位数</label>
                <input style="width:20%;" type="text" id="node-input-RD_Num" placeholder="number">
            </li>
        </ul>
    </div>
    <div class="form-row">
        <ul class="WR">
            <li><label for="node-input-WR_Addr"></i> 起始地址</label>
                <input style="width:20%;" type="text" id="node-input-WR_Addr" placeholder="start address">
            </li>
            <li> <label for="node-input-WR_Value"> 写入数值</label>
                <input style="width:20%;" type="text" id="node-input-WR_Value" placeholder="value">
            </li>
        </ul>
    </div>

</script>

<script type="text/javascript">
    RED.nodes.registerType('Keyence', {
        category: 'PLC',
        color: "Skyblue",
        defaults: {
            name: {
                value: ""
            },
            server: {
                value: "",
                required: true
            },
            port: {
                value: "",
                validate: RED.validators.regex(/^(\d*|)$/),
                required: true

            },
            out: {
                value: "time",
                required: true
            },
            splitc: {
                value: "0",
                required: true
            },
            model: {
                value: "read",
            },
            //读取PLC起始地址
            RD_Addr: {
                value: "",
                validate: function(v) {
                    return (this.model != "read") || v.length > 0;
                }
            },
            //获取位数
            RD_Num: {
                value: "",
                validate: function(v) {
                    return (this.model != "read") || v.length > 0;
                }
            },
            //写地址
            WR_Addr: {
                value: "",
                validate: function(v) {
                    return (this.model != "write") || v.length > 0;
                }
            },
            //写值
            WR_Value: {
                value: "",
                validate: function(v) {
                    return (this.model != "write") || v.length > 0;
                }
            },

        },
        inputs: 1,
        outputs: 1,
        icon: "bridge-dash.svg",
        label: function() {
            return this.name || 'Keyence';
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            var previous = null;
            $("#node-input-out").on('focus', function() {
                previous = this.value;
            }).on("change", function() {
                $("#node-input-splitc").show();
                if (previous === null) {
                    previous = $("#node-input-out").val();
                }
                if ($("#node-input-out").val() == "char") {
                    if (previous != "char") {
                        $("#node-input-splitc").val("\\n");
                    }
                    $("#node-units").text("");
                } else if ($("#node-input-out").val() == "time") {
                    if (previous != "time") {
                        $("#node-input-splitc").val("0");
                    }
                    $("#node-units").text(RED._("node-red:tcpin.label.ms"));
                } else if ($("#node-input-out").val() == "immed") {
                    if (previous != "immed") {
                        $("#node-input-splitc").val(" ");
                    }
                    $("#node-units").text("");
                    $("#node-input-splitc").hide();
                } else if ($("#node-input-out").val() == "count") {
                    if (previous != "count") {
                        $("#node-input-splitc").val("12");
                    }
                    $("#node-units").text(RED._("node-red:tcpin.label.chars"));
                } else {
                    if (previous != "sit") {
                        $("#node-input-splitc").val(" ");
                    }
                    $("#node-units").text("");
                    $("#node-input-splitc").hide();
                }
            });
            $("#node-input-model").on('focus', function() {
                previous = this.value;
            }).on("change", function() {
                // $(".RD").show();
                // if (previous === null) {
                //     previous = $("#node-input-model").val();
                // }
                if ($("#node-input-model").val() == "write") {
                    $(".RD").hide();
                    $(".WR").show(500);
                } else {
                    $(".WR").hide();
                    $(".RD").show(500);
                }
            });

        }
    });
</script>

<style>
    #red-ui-main-container {
        background-color: red !important;
    }
    
    input,
    select {
        margin: 5px !important;
        padding: 2px !important;
        height: 25px !important;
    }
    
    li {
        list-style: none;
    }
    
    .form-row ul {
        margin: 0;
        padding: 0;
    }
    
    .border_bottom {
        padding-bottom: 10px;
        border-bottom: 1px solid #ccc;
    }
</style>